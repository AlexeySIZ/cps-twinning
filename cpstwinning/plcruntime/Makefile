CC=gcc
STFILE=$(ST_FILE_PATH)
PLCNAME=$(PLC_NAME)
CONFIGURATIONNAME=$(ST_CONFIGURATION_NAME)
RESOURCENAME=$(ST_RESOURCE_NAME)
PREPREPROCESSOR=../prepreprocessor.py
SRCDIR=./src
TMPBASE=/tmp/cps-twinning
PLCRUNTIMEINCLUDEPATH=./inc
DSTDIR=$(TMPBASE)/$(PLCNAME)
IECGENERATEDERATEDSOURCES=$(DSTDIR)/$(CONFIGURATIONNAME).c $(DSTDIR)/$(RESOURCENAME).c
SOURCES=$(IECGENERATEDERATEDSOURCES) $(DSTDIR)/plc_runtime.c
OBJECTS=$(SOURCES:.c=.o)
CFLAGS=-I$(MATIEC_C_INCLUDE_PATH) -I$(PLCRUNTIMEINCLUDEPATH) -I$(DSTDIR) -c -fPIC -g -O0
LDFLAGS=-lrt -shared
SHAREDLIBRARY=$(DSTDIR)/lib$(PLCNAME).so

all: init iec2c build

init:
	mkdir -p $(DSTDIR)

iec2c: $(STFILE) $(IECGENERATEDERATEDSOURCES) prepreprocess

build: $(SOURCES) $(SHAREDLIBRARY)

$(IECGENERATEDERATEDSOURCES): $(STFILE)
	iec2c $(STFILE) -I $(MATIEC_INCLUDE_PATH) -T $(DSTDIR)

prepreprocess:
	python $(PREPREPROCESSOR)

$(DSTDIR)/%.o: $(SRCDIR)/%.c $(DSTDIR)/%.c Makefile
	$(CC) $(CFLAGS) -c $<

$(SHAREDLIBRARY): $(OBJECTS)
	$(CC) $(OBJECTS) -o $@ $(LDFLAGS)

clean:
	rm $(DSTDIR)/POUS.c
	rm $(DSTDIR)/POUS.h
	rm $(DSTDIR)/LOCATED_VARIABLES.h
	rm $(DSTDIR)/VARIABLES.csv
	rm $(DSTDIR)/$(CONFIGURATIONNAME).c
	rm $(DSTDIR)/$(CONFIGURATIONNAME).h
	rm $(DSTDIR)/$(RESOURCENAME).c
	rm $(DSTDIR)/plc_runtime.c
	rm $(DSTDIR)/*.o
	rm $(SHAREDLIBRARY)
	rm -r $(DSTDIR)

fresh: | clean all
